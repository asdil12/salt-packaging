From 30340c376569f733076b30b378513fb96485b467 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Pablo=20Su=C3=A1rez=20Hern=C3=A1ndez?=
 <psuarezhernandez@suse.com>
Date: Mon, 25 Jan 2021 12:15:59 +0000
Subject: [PATCH] Do not crash when unexpected cmd output at listing
 patches (bsc#1181290)

---
 salt/modules/yumpkg.py | 14 ++++++++++++--
 1 file changed, 12 insertions(+), 2 deletions(-)

diff --git a/salt/modules/yumpkg.py b/salt/modules/yumpkg.py
index fdb5e3db8a..5be6bd4f5c 100644
--- a/salt/modules/yumpkg.py
+++ b/salt/modules/yumpkg.py
@@ -3004,9 +3004,16 @@ def _get_patches(installed_only=False):
         python_shell=False,
         env={"SALT_RUNNING": '1'}
     )
+    parsing_errors = False
+
     for line in salt.utils.itertools.split(ret, os.linesep):
-        inst, advisory_id, sev, pkg = re.match(r'([i|\s]) ([^\s]+) +([^\s]+) +([^\s]+)',
-                                               line).groups()
+        try:
+            inst, advisory_id, sev, pkg = re.match(r'([i|\s]) ([^\s]+) +([^\s]+) +([^\s]+)',
+                                                   line).groups()
+        except Exception:
+            parsing_errors = True
+            continue
+
         if not advisory_id in patches:
             patches[advisory_id] = {
                 'installed': True if inst == 'i' else False,
@@ -3017,6 +3024,9 @@ def _get_patches(installed_only=False):
             if inst != 'i':
                 patches[advisory_id]['installed'] = False
 
+    if parsing_errors:
+        log.warning("Skipped some unexpected output while running '{0}' to list patches. Please check output".format(" ".join(cmd)))
+
     if installed_only:
         patches = dict((k, v) for k, v in patches.items() if v['installed'])
     return patches
-- 
2.29.2


